<!DOCTYPE html>
<html>
  <head>
    <title>Composer tests</title>
    <script src="../lib/composer.js"></script>
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <link rel="stylesheet" href="http://github.com/jquery/qunit/raw/master/qunit/qunit.css" type="text/css" media="screen" />
    <script type="text/javascript" src="http://github.com/jquery/qunit/raw/master/qunit/qunit.js"></script>
    <script src="lib/mouse.js"></script>
    <script type="text/javascript">
      $(document).ready(function() {
        test("As a developer I'd like to easily add components for rendering", function() {
            var canvas   = jQuery("<canvas></canvas>")[0];
            var instance = Composer(canvas, null, [Composer.Renderer]);
            // basic tests
            ok(instance, "New composer created successfully");
            try {
              Composer();
              ok(false, "Composer requires a canvas");
            } catch (e) {
              ok(true, "Composer detects an invalid canvas");
            }

            ok(instance.version, "This is actually a Composer");
            ok(canvas.composer === instance, "Canvas has been augmented to contain a reference to the composer");
            ok(instance.canvas === canvas, "Composer holds a reference to the dom canvas element");

            // Parts testing
            ok(instance.renderer, "Renderer is automatically added into the composer");

            // No parts
            var noParts = Composer(jQuery("<canvas></canvas>"), null, []);
            ok(!noParts.renderer, "When you specify no parts, no parts are added");

            // Remove renderables
            var renderable = Composer.create({},[Composer.Renderable]);
            instance.renderer.add(renderable);
            ok(instance.renderer.length === 1, "Renderable successfully added to Renderer");
            instance.renderer.remove(renderable);
            ok(instance.renderer.length === 0, "Renderable successfully removed from Renderer")

            // Renderable methods
            var pos = Composer.create({}, [Composer.Renderable]);
            pos.setPos(1,2,3);
            ok(pos.getPos().x === 1 && 
               pos.getPos().y === 2 && 
               pos.getPos().z === 3, "Position set on renderable");

            pos.setSize(90,10);
            ok(pos.getSize().width === 90 && pos.getSize().height === 10, "Size set on renderable");

        });

        test("As a developer I need Composer's renderer to render consistently", function() {
          var instance   = Composer(jQuery("<canvas></canvas>")[0], null, [Composer.Renderer]),
              first  = Composer.create({}, null, [Composer.Renderable]),
              lastRendered = null;

          first.setPos(0,0,10);

          // Render order
          ok(instance.renderer.renderIndex(first) === 0, "Objects created with Composer.create are added to the render stack");
          second = Composer.create({}, null, [Composer.Renderable]).setPos(0,0,10);
          ok(instance.renderer.renderIndex(second) === 1, "A newly added node with the same z is at the second render index");
          
          first.z = 100;
          ok(instance.renderer.renderIndex(first) === 1, "The render stack resorted correctly");
          
        });

        test("As a user I would like to move nodes around the composer", function() {
          var canvas   = jQuery("<canvas></canvas>")[0],
              instance = Composer(canvas)
              node     = Composer.create({}, [Composer.Renderable, Composer.Collidable]);

          // Mouse collision (Picking)
          node.setPos(2,2,0).setSize(10,10);
          ok(node.collides.aabb(10,10), "Basic AABB collision is functional");
        
        });
      });

    </script>
  </head>
  <body>
    <h1 id="qunit-header">Composer Tests</h1>
    <h2 id="qunit-banner"></h2>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>
  </body>
</html>