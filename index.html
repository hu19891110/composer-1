<html>
  <head>
    <title>Composer</title>
    <style>
      body { margin:0px; padding:0px;}
    </style>
    <script type="text/javascript" src="lib/composer.js"></script>
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script type="text/javascript">
      jQuery(function() {
        jQuery("canvas").attr("width", jQuery(document).width());
        jQuery("canvas").attr("height", jQuery(document).height());
        var instance = Composer(document.getElementById("example1"), {fps: 30}, 
                                [
                                  Composer.Renderable, 
                                  Composer.Renderer, 
                                  Composer.DragManager, 
                                  Composer.Collidable, 
                                  Composer.Draggable]);
        
        window.example1 = instance;

        instance.setPos(0,0,-1).setSize(jQuery("canvas").attr("width"), jQuery("canvas").attr("height"));
        instance.dragstart = function(ev) {
          instance.z = -10;
          var ox = ev.canvasOffset.x-instance.x, oy = ev.canvasOffset.y-instance.y;
          
          if (instance.hasOwnProperty('x') && instance.hasOwnProperty('y')) {
            //ox += instance.x;
            //oy += instance.y;
          }

          instance.mouseOffset = {x:ox, y:oy};
        };
        
        instance.dragging = function(ev) {
          var ox = ev.canvasOffset.x-instance.mouseOffset.x, oy = ev.canvasOffset.y-instance.mouseOffset.y;
          instance.setPos(ox, oy, -10);
        };
        
        Composer.Renderer(instance);
        
        var renders = 0, fps = 0, seconds=0, nodesRendered = 0;
        
        setInterval(function() {
          fps = renders;
          renders = 0;
          document.title = "Composer (" + nodesRendered + " @ " + Math.ceil(fps) + " fps)";
        },1000)
        
        instance.renderer.start(function() {
          renders++;
          nodesRendered = 0;
        });
        
        var canvasWidth = jQuery("canvas").attr("width"),
            size  = 50,
            total = (canvasWidth/size * canvasWidth/size),
            width =  jQuery("canvas").attr("width")/size;
        
        // TODO: move this into core, probably into a "NodeBuilder" feature/part    
        function createNode(x,y,z,color) {
          var node = Composer.create({}, [Composer.Renderable, Composer.Collidable, Composer.Draggable]);
          node.setSize(size,size).setPos(x,y,z);

          node.color = color || "rgb(" +  (x%255) + "," + (y%127) + "," + (y%255) + ")";
          node.render = function(data) {
            nodesRendered++;
            var x = node.x+data.relativeX, y = node.y + data.relativeY;
            this.composer.renderer.context.fillStyle = node.color ;
            this.composer.renderer.context.fillRect(x,
                                                    y,
                                                    node.getSize().width,
                                                    node.getSize().height);
            this.composer.renderer.context.fillStyle = "#FFFFFF";
            this.composer.renderer.context.fillText("z: " + node.z, x+10, y+10);
            
            this.composer.renderer.context.fillText("" + node.id, x+15, y+25);
          };
        }
        
        for (var i=0; i<total; i++)
        { 
          var base = i*size;
          var x = base%canvasWidth, y = Math.floor(base/canvasWidth)*size;
          createNode(x,y,0);
        }
        
        // TODO: refactor into core
        var green = 0;
        document.addEventListener("keydown", function(ev) {
          switch (ev.keyCode) {
            case 78:
              if (ev.ctrlKey) {
                green+=10
                createNode(100, 100, green/10, "rgb(" + (green*2%255) + "," + (green%127) + "," + (green%255) + ")");
              }
            break;
          }
        }, true);
        
        
      });
    </script>
  </head>
  <body>
      <canvas id="example1" width="300" height="300"></canvas>
  </body>
</html>
