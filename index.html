<!DOCTYPE html>
<html>
  <head>
    <title>Composer</title>
    <style>
      body { margin:0px; padding:0px;}
    </style>
    <script type="text/javascript" src="../carena/lib/carena.js"></script>
    <script type="text/javascript" src="lib/composer.js"></script>
    <script type="text/javascript" src="../cider/lib/cider.js"></script>

    <script src="lib/jquery.js"></script>
    <script type="text/javascript">
      jQuery(function() {

        var feature = carena.feature,
            renderer = carena.build({}, ["carena.Renderer"], {
              canvas: document.getElementById("composer")
            }),
            camera = carena.build({}, ["carena.Camera", "carena.DropManager"], {
              renderer: renderer
            }),
            scene = carena.build({}, ["carena.Node", "carena.Eventable"]);

            var fromTransport = function(obj) {
              var flow = carena.build({}, obj.scene.features, obj.scene.settings || {});
              if (obj.scene.children && obj.scene.children.length > 0) {
                for (var nodeIdx = 0; nodeIdx<obj.scene.children.length; nodeIdx++) {
                  // build an array of node features
                  var current = obj.scene.children[nodeIdx];
                  flow.add(carena.build({}, current.features, current.settings || {}));
                }
              }
              return flow;
            };

            var toTransport = function(branch) {
              var res = {
                features : {
                  "carena.feature" : "http://tmpvar.com/project/carena/lib/carena.js"
                },
                scene : {}
              }, loc = scene;

              function recurse(node) {
                var transport = { 
                  settings: node.dehydrate(),
                  features: node.features
                };
                var children = false;
                if (node.children && node.children.length) {
                  children = [];
                  for (var i = 0; i<node.children.length; i++) {
                    children.push(recurse(node.children[i]));
                  }
                }
                
                if (children !== false) {
                  transport.children = children;
                }
                return transport;
              }
              res.scene = recurse(branch);
              return res;
            };

          jQuery.ajax({
            url : "/flows/THEFLOW",
            dataType: "json",
            success : function(data) {
              var saving = false;
              var scene = fromTransport(JSON.parse(data));
              
              scene.event.bind("node.dirty", function() {
                if (!saving) {
                  saving = true;
                  jQuery.ajax({
                    type : "post",
                    url  : "/flows/",
                    data : JSON.stringify(toTransport(scene)),
                    contentType : "application/json",
                    success : function(data) {
                      console.log(data);
                      saving = false;
                    }
                  });
                }
              });

              camera.target = scene;

              setTimeout(function render() {
                camera.render();
                setTimeout(render, 10);
              }, 0);
            }
          })

            document.addEventListener("keydown", function(ev) {
              if (ev.keyCode === 78 && ev.ctrlKey === true) {
                ev.preventDefault();
                // spawn a new carena
                var editorWindow = BaseNode({
                  color: "blue",
                  x:100, y: 100,
                  height: 400,
                  width: 400
                },[] /* TODO: fix me */),
                editor       = carena.build({
                  x:110,y:150, width: 380, height: 340
                }, [
                  "carena.Node",
                  "carena.RelativeToParent",
                  "cider.Textual",
                  "cider.Editable",
                ]),
                lineNumbers = carena.build({},[
                  "cider.LineNumbers",
                  "carena.RelativeToParent"
                ]);

                camera.add(editorWindow.add(editor.add(lineNumbers)));
              }
            }, true);

      });
    </script>
  </head>
  <body>
      <canvas id="composer" width="600" height="600"></canvas>
  </body>
</html>
