<!DOCTYPE html>
<html>
  <head>
    <title>Composer</title>
    <style>
      body { margin:0px; padding:0px;}
    </style>
    <script type="text/javascript" src="../carena/lib/carena.js"></script>
    <script type="text/javascript" src="lib/composer.js"></script>
    <script type="text/javascript" src="../cider/lib/cider.js"></script>

    <script src="lib/jquery.js"></script>
    <script type="text/javascript">
      jQuery(function() {

        var feature = carena.feature,
            renderer = carena.build({}, ["carena.Renderer"], {
              canvas: document.getElementById("composer")
            }),
            camera = carena.build({}, ["carena.Camera", "carena.DragManager", "carena.DropManager"], {
              renderer: renderer
            }),
            scene;

            var fromTransport = function(obj) {
              var flow = carena.build({}, obj.scene.features, obj.scene.settings || {});

              function recurse(node, data) {
                if (data.children && data.children.length > 0) {
                  for (var nodeIdx = 0; nodeIdx<data.children.length; nodeIdx++) {
                    // build an array of node features
                    var current = data.children[nodeIdx],
                        built   = carena.build({}, current.features, current.settings || {});
                    node.add(recurse(built, current));
                  }
                }
                return node;
              }
              return recurse(flow, obj.scene);
            };

            var toTransport = function(branch) {
              var res = {
                features : {
                  "carena.feature" : "http://tmpvar.com/project/carena/lib/carena.js"
                },
                scene : {}
              };

              function recurse(node) {
                var transport = {
                  settings: node.dehydrate(),
                  features: node.features
                };
                var children = false;
                if (node.children && node.children.length) {
                  children = [];
                  for (var i = 0; i<node.children.length; i++) {
                      children.push(recurse(node.children[i]));
                  }
                }

                if (children !== false) {
                  transport.children = children;
                }
                return transport;
              }

              res.scene = recurse(branch);
              return res;
            };

            var saving = false;
            function save() {
              if (!saving) {
                saving = true;
                jQuery.ajax({
                  type : "post",
                  url  : "/flows/",
                  data : JSON.stringify(toTransport(scene)),
                  contentType : "application/json",
                  success : function(data) {
                    saving = false;
                  }
                });
              }
            }
            var selected = null;
            jQuery.ajax({
              url : "/flows/THEFLOW",
              dataType: "json",
              success : function(data) {
                scene = fromTransport(data);
              },
              error : function() {
                scene = carena.build({
                  x:10, y: 10, width: 160, height: 160,
                  style : { backgroundColor:"red" }
                },
                ["carena.Node", "carena.Draggable"])
              },
              complete: function() {
                scene.event.bind("node.dirty", save);
                scene.event.bind("mouse.down", function(name, data) {
                  selected = data.target;
                });
                camera.target = scene;
                scene.dirty = true;
                setTimeout(function render() {
                  camera.render();
                  setTimeout(render, 10);
                }, 0);
              }
            })

            var chooser = null;
            document.addEventListener("keydown", function(ev) {
              if (ev.keyCode === 8) {
                ev.preventDefault();
                ev.stopPropagation();

                if (selected) {
                  var parent = selected.parent;
                  selected.parent.remove(selected);
                  selected = parent.child(0);
                }

              } else if (ev.keyCode === 32) {
                // Spawn a dialog for choosing a node from the db
                if (chooser === null) {
                  chooser = true;
                  jQuery.ajax({
                    url: "/nodes",
                    dataType: "json",
                    success: function(data) {
                      //var data = JSON.parse(data);
                      console.log(data);
                    }
                  });
                  
                }
              
                /*
                var rnd = carena.build({x:20, y: 20, width: 100, height:100,
                  color: "rgb(" + (new Date()).getTime()%255 +
                         ", 128," + Math.round(Math.random()*200%255) + ")"
                }, [
                  "carena.Node", "carena.Draggable", "composer.Functional"
                ]);
                jQuery.ajax({
                  url: "/nodes/" + name.toString(),
                  dataType: "json",
                  success: function(data) {
                    var data = JSON.parse(data);

                    camera.add(editorWindow.add(editor.add(lineNumbers)).add(name).add(saveButton));
                  }
                });

                var port = carena.build({x:10, y: 10, width: 20, height:20,
                  color: "green"
                }, [
                  "carena.RelativeToParent", "composer.Port"
                ]);

                scene.add(rnd.add(port));*/
              } else if (ev.keyCode === 78 && ev.ctrlKey === true) {
                spawnEditor(true, "test", "-\n--");
              }
            }, true);
            
            function spawnEditor(newNode, nodeName, nodeCode) {
              //ev.preventDefault();
              // spawn a new carena
              var editorWindow = carena.build({
                color: "blue",
                x:100, y: 100,
                height: 310,
                width: 400
              },[
                "carena.Node",
                "carena.Draggable"
              ]),
              editor       = carena.build({
                x:110,y:140, width: 380, height: 260
              }, [
                "carena.Node",
                "carena.RelativeToParent",
                "cider.Textual",
                "cider.Editable",
                "cider.FocusTarget"
              ]),
              lineNumbers = carena.build({},[
                "cider.LineNumbers",
                "carena.RelativeToParent"
              ]),
              name = carena.build({
                x:110,
                y:110,
                width: 270,
                height: 20,
                textOffset : {
                  x: 10,
                  y: 5
                }
              },[
                "carena.Node",
                "carena.RelativeToParent",
                "cider.Textual",
                "cider.Editable",
                "cider.FocusTarget"
              ]),
              saveButton = carena.build({
                width: 80,
                height: 20,
                x:410,
                y:110,
                color: "grey"
              },[
                "carena.Node",
                "carena.Eventable",
                "carena.RelativeToParent"
              ]);

              name.fromString(nodeName);

              // Setup the button
              // TODO: this probably could be made easier heh.
              saveButton.event.bind("mouse.in", function() {
                saveButton.color = "orange";
                return false;
              });
              saveButton.event.bind("mouse.out", function(name, data) {
                saveButton.color = "grey";
                return false;
              });
              saveButton.render = function(renderer) {

                renderer.context.fillStyle = saveButton.color;
                renderer.context.fillRect(saveButton.x,
                                          saveButton.y,
                                          saveButton.width,
                                          saveButton.height);

                renderer.context.fillStyle = "black";
                renderer.context.fillText("save", saveButton.x+20, saveButton.y+14);
              };
              function mouseUp(evName, data) {
                if (data.target === saveButton) {
                  // Save to storage

                  // remove the editor
                  // TODO: figure out the root cause of this
                  if (!editor.parent || !name.parent || !editorWindow.parent) {
                    return;
                  }
                  var req = {
                    contentType: "application/json",
                    dataType : "json",
                    data : JSON.stringify({
                      name: name.toString(),
                      code: editor.toString()
                    }),
                    success : function() {
                      editor.parent.remove(editor);
                      name.parent.remove(name);
                      editorWindow.parent.remove(editorWindow);
                    }
                  };
                  req.url = (newNode) ? "/nodes" : "/nodes/" + name.toString();
                  req.type = (newNode) ? "post" : "put";
                  jQuery.ajax(req);
                  return false;
                }
              }
              saveButton.event.bind("mouse.up", mouseUp);
              editor.fromString(nodeCode);

              camera.add(editorWindow.add(editor.add(lineNumbers)).add(name).add(saveButton));
            }

      });
    </script>
  </head>
  <body>
      <canvas id="composer" width="600" height="600"></canvas>
  </body>
</html>
