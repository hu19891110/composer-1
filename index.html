<!DOCTYPE html>
<html>
  <head>
    <title>Composer</title>
    <style>
      body { margin:0px; padding:0px;}
    </style>
    <script type="text/javascript" src="../carena/lib/carena.js"></script>
    <script type="text/javascript" src="lib/composer.js"></script>
    <script type="text/javascript" src="../cider/lib/cider.js"></script>

    <script src="lib/jquery.js"></script>
    <script type="text/javascript">
      jQuery(function() {

        var feature = carena.feature,
            renderer = carena.Build({}, [feature.Renderer], {
              canvas: document.getElementById("composer")
            }),
            camera = carena.Build({}, [feature.Camera, feature.DropManager], {
              renderer: renderer
            }),
            scene = carena.Build({}, [feature.Node, feature.Eventable]);

            var fromTransport = function(obj) {
              // setup namespaces

              var features = {

              };

              for (var name in obj.features) {
                if (obj.features.hasOwnProperty(name)) {
                  var pos = window,
                      url = obj.features[name],
                      s = name.split(".");

                  // Navigate the object to get to the feature list
                  for (var j=0; j<s.length; j++) {

                    if (pos[s[j]]) {
                      pos = pos[s[j]];
                    } else {
                      throw new Error("Please include " + url);
                    }
                  }
                  features[name] = pos;
                }
              }

              for (var nodeIdx = 0; nodeIdx<obj.scene.length; nodeIdx++) {
                // build an array of node features
                var nodeFeatures = [], current = obj.scene[nodeIdx];
                for (var f = 0; f<current.features.length; f++) {
                  var nodeFeature = current.features[f],
                      s           = nodeFeature.split("."),
                      str         = [],
                      match       = false;

                    while(s.length>0) {
                      str.push(s.shift());
                      if (features[str.join(".")]) {
                        match = features[str.join(".")];
                        break;
                      }
                    }
                  if (!match) {
                    throw new Error("Feature not defined " + nodeFeature);
                  }

                  // ensure the last part of the feature exists
                  var absFeature = match, parts = [];
                  while (s.length>0) {
                    var part = s.shift();
                    parts.push(part);
                    if (absFeature[part]) {
                      absFeature = absFeature[part];
                    } else {
                      throw new Error(str.join(".") +
                                      " does not have a " +
                                      parts.join(".") + " feature");
                    }
                  }
                  nodeFeatures.push(absFeature);
                }
                return carena.Build(current.settings || {}, nodeFeatures);
              }
              return features;
            };

            var toTransport = function(branch) {
              var res = {
                features : {
                  "carena.feature" : "http://tmpvar.com/project/carena/lib/carena.js"
                },
                scene : []
              }, loc = scene;

              branch.walk(function(node, callback) {
                if (node) {
                  console.log(callback(node));
                  if (node.children && node.children.length > 0) {
                    var l = node.children.length, i = 0;
                    for (i; i<l; i++) {
                      console.log("callback:",callback(node.children[i]));
                    }
                  }
                }
              },
              function(node, walker) {
                var transport = { settings: {} };
                for (var p in node) {
                  if (node.hasOwnProperty(p)) {
                    if (typeof node[p] !== 'function') {
                      transport.settings[p] = node[p];
                    }
                  }
                }
                return transport;
              });
              return res;
            };

            var scene = fromTransport({
              features : {
               "carena.feature" : "http://tmpvar.com/project/carena/lib/carena.js",
               "composer.feature" : "http://tmpvar.com/project/composer/lib/composer.js"
              },
              scene : [
                {
                   settings : {
                     x: 0,
                     y: 0,
                     width: 100,
                     height: 100,
                     color: "red"
                  },
                  children : [
                    {
                      settings : {},
                      children: [],
                    }
                  ],
                  features : [
                    "carena.feature.Node",
                    "carena.feature.Eventable",
                    "carena.feature.Draggable"
                  ]
                }
              ]
          });
          camera.target = scene;

          console.dir(toTransport(scene));
            setTimeout(function render() {
              camera.render();
              setTimeout(render, 10);
            }, 0);

            document.addEventListener("keydown", function(ev) {
              if (ev.keyCode === 78 && ev.ctrlKey === true) {
                ev.preventDefault();
                // spawn a new carena
                var editorWindow = BaseNode({
                  color: "blue",
                  x:100, y: 100,
                  height: 400,
                  width: 400
                },[] /* TODO: fix me */),
                editor       = carena.Build({
                  x:110,y:150, width: 380, height: 340
                }, [
                  feature.Node,
                  feature.RelativeToParent,
                  cider.feature.Textual,
                  cider.feature.Editable,
                ]),
                lineNumbers = carena.Build({},[
                  cider.feature.LineNumbers,
                  feature.RelativeToParent
                ]);

                camera.add(editorWindow.add(editor.add(lineNumbers)));
              }
            }, true);

      });
    </script>
  </head>
  <body>
      <canvas id="composer" width="600" height="600"></canvas>
  </body>
</html>
